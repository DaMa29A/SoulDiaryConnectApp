<!DOCTYPE html>
{%  load static %}
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Paziente - SoulDiaryConnect</title>
    <link rel="stylesheet" href="{% static 'SoulDiaryConnectApp/css/paziente_home.css' %}">
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="/media/2-01.png" alt="SoulDiaryConnect">
            <h1>Benvenuto, {{ paziente.nome }} {{ paziente.cognome }}</h1>
        </div>
        <a href="{% url 'logout' %}" class="logout-btn">
            Logout
            <img src="/media/logout_white.png" alt="">
        </a>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h2>
                <img src="/media/stethoscope.png" alt="">
                Il tuo medico
            </h2>

            <div class="doctor-card">
                <p><strong>Nome:</strong> {{ medico.nome }} {{ medico.cognome }}</p>
                <p><strong>Indirizzo:</strong> {{ medico.indirizzo_studio }}, {{ medico.numero_civico }} - {{ medico.citta }}</p>
                <p><strong>Email:</strong> {{ medico.email }}</p>
                <p><strong>Tel. Studio:</strong> {{ medico.numero_telefono_studio }}</p>
                <p><strong>Tel. Cellulare:</strong> {{ medico.numero_telefono_cellulare }}</p>
            </div>

            <div class="divider"></div>

            <div class="add-note-section">
                <h2>Aggiungi una nuova nota</h2>
                <form method="POST" id="addNoteForm" onsubmit="showLoadingModal(event)">
                    {% csrf_token %}
                    <textarea name="desc" placeholder="Scrivi qui i tuoi pensieri..." rows="8" required></textarea>

                    <div class="checkbox-group">
                        <input type="checkbox" name="generateResponse" id="generateResponse">
                        <label for="generateResponse">Genera automaticamente frasi di supporto</label>
                    </div>

                    <button type="submit" class="submit-btn">Aggiungi Nota</button>
                </form>
            </div>
        </div>

        <div class="notes-section">
            <h2>
                <img src="/media/writing.png" alt="">
                Le tue note diario
            </h2>

            {% if note_diario %}
                {% for nota in note_diario %}
                    <div class="note-card">
                        <p><strong>Data:</strong> {{ nota.data_nota|date:"d/m/Y" }}</p>
                        <p><strong>Nota:</strong> {{ nota.testo_paziente }}</p>

                        {% if nota.testo_supporto %}
                            <div class="note-separator"></div>
                            <div class="support-text">
                                <p><strong>üíô Supporto:</strong> {{ nota.testo_supporto }}</p>
                            </div>
                        {% endif %}

                        {% if nota.testo_medico or nota.testo_medico == "None" %}
                            <div class="note-separator"></div>
                            <div class="doctor-comment">
                                <p><strong>ü©∫ Cosa ne pensa il medico:</strong> {{ nota.testo_medico }}</p>
                            </div>
                        {% endif %}
                        <button type="button" class="delete-btn" 
    data-id="{{ nota.id }}" 
    data-data="{{ nota.data_nota|date:'d/m/Y'|escapejs }}" 
    data-nota="{{ nota.testo_paziente|escapejs }}" 
    onclick="openDeleteModalFromButton(this)" 
    style="background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-top:10px;">
    Elimina
</button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>Non ci sono ancora note disponibili.</p>
                    <p>Inizia a scrivere il tuo diario!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal di conferma eliminazione -->
    <div id="deleteModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2 style="color:#dc3545;">Conferma eliminazione</h2>
            <p id="modalData"></p>
            <p id="modalNota"></p>
            <form method="POST" id="deleteForm">
                {% csrf_token %}
                <button type="submit" class="submit-btn" style="background:#dc3545;">Elimina definitivamente</button>
                <button type="button" class="submit-btn" style="background:#6c757d;margin-left:12px;" onclick="closeDeleteModal()">Annulla</button>
            </form>
        </div>
    </div>

    <!-- Modal di caricamento -->
    <div id="loadingModal" class="modal-overlay loading-modal" style="display:none;">
        <div class="modal-content">
            <div class="note-icon">üìù</div>
            <h2>Generazione nota in corso...</h2>
            <p style="color: #475569; font-size: 15px;">Stiamo elaborando la tua nota e generando il supporto personalizzato</p>
            <div class="loading-animation">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <script>
        function showLoadingModal(event) {
            // Mostra il modal di caricamento
            document.getElementById('loadingModal').style.display = 'flex';
            // Permetti l'invio del form
            return true;
        }

        function openDeleteModalFromButton(btn) {
            var notaId = btn.getAttribute('data-id');
            var dataNota = btn.getAttribute('data-data');
            var testoNota = btn.getAttribute('data-nota');
            openDeleteModal(notaId, dataNota, testoNota);
        }
        function openDeleteModal(notaId, dataNota, testoNota) {
            document.getElementById('modalData').innerHTML = '<strong>Data:</strong> ' + dataNota;
            document.getElementById('modalNota').innerHTML = '<strong>Nota:</strong> ' + testoNota;
            var form = document.getElementById('deleteForm');
            form.action = '/paziente/note/' + notaId + '/elimina/';
            document.getElementById('deleteModal').style.display = 'flex';
        }
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }
    </script>
</body>
</html>